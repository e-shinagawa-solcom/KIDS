<?php

require_once ('conf.inc');
require_once (SRC_ROOT. "/estimate/cmn/const/workSheetConst.php");

/**
*	¥ï¡¼¥¯¥·¡¼¥È¤ÎºÆ·×»»¡¢¥Ç¡¼¥¿¥Á¥§¥Ã¥¯¥¯¥é¥¹
*	
*	°Ê²¼¤Î¥°¥í¡¼¥Ð¥ëÊÑ¿ô¤òÄêµÁ¤¹¤ë¤³¤È
*   @param object $objDB        ¥Ç¡¼¥¿¥Ù¡¼¥¹ÀÜÂ³¥ª¥Ö¥¸¥§¥¯¥È(clsDB¤Þ¤¿¤Ï·Ñ¾µ¥¯¥é¥¹)
*   @param object $sheet        phpSpreadSheet¤Î¥·¡¼¥È¥ª¥Ö¥¸¥§¥¯¥È
*   
*/

class estimateTotalCalculationController {

    protected $errorMessage; // ¥¨¥é¡¼¥á¥Ã¥»¡¼¥¸
    protected $messageCode;

    // ½ÐÎÏÃÍ
    public $productionQuantity;                 // ½þµÑ¿ô pcs
    public $receiveProductTotalPrice;           // À½ÉÊÇä¾å¹ç·×
    public $receiveProductTotalQuantity;        // À½ÉÊ¿ôÎÌ¹ç·×
    public $receiveFixedCostTotalPrice;         // ¸ÇÄêÈñÇä¾å¹ç·×
    public $receiveFixedCostTotalQuantity;      // ¸ÇÄêÈñ¿ôÎÌ¹ç·×
    public $orderFixedCostTotalPrice;           // ¸ÇÄêÈñ¾®·×
    public $orderFixedCostNotDepreciation;      // ½þµÑÂÐ¾Ý³°¹ç·×
    public $productTotalPrice;                  // À½ÉÊÇä¾å¹â
    public $productProfit;                      // À½ÉÊÍø±×
    public $productProfitRate;                  // (À½ÉÊÍø±×Î¨)
    public $fixedCostTotalPrice;                // ¸ÇÄêÈñÇä¾å¹â
    public $fixedCostProfit;                    // ¸ÇÄêÈñÍø±×
    public $fixedCostProfitRate;                // (¸ÇÄêÈñÍø±×Î¨)
    public $salseAmount;                        // ÁíÇä¾å¹â
    public $profit;                             // Çä¾åÁíÍø±×
    public $profitRate;                         // (Íø±×Î¨)
    public $indirectCost;                       // ´ÖÀÜÀ½Â¤·ÐÈñ
    public $standardRate;                       // É¸½à³ä¹ç
    public $operatingProfit;                    // ±Ä¶ÈÍø±×
    public $operatingProfitRate;                // (±Ä¶ÈÍø±×Î¨)
    public $memberQuantity;                     // ÉôºàÈñ¡Ê¿ôÎÌ¡Ë
    public $memberUnitCost;                     // ÉôºàÈñ¡ÊÃ±²Á¡Ë
    public $memberCost;                         // ÉôºàÈñ
    public $depreciationQuantity;               // ½þµÑÈñ¡Ê¿ôÎÌ¡Ë
    public $depreciationUnitCost;               // ½þµÑÈñ¡ÊÃ±²Á¡Ë
    public $depreciationCost;                   // ½þµÑÈñ
    public $manufacturingQuantity;              // À½Â¤ÈñÍÑ¡Ê¿ôÎÌ¡Ë
    public $manufacturingUnitCost;              // À½Â¤ÈñÍÑ¡ÊÃ±²Á¡Ë
    public $manufacturingCost;                  // À½Â¤ÈñÍÑ
    public $costNotDepreciation;                // ½þµÑÂÐ¾Ý³°¸ÇÄêÈñ

    // ¥Þ¥¹¥¿¡¼¥Ç¡¼¥¿ÇÛÎó

    // ¥»¥ëÌ¾¾Î¥ê¥¹¥È
    protected static $nameList; // ¥Ø¥Ã¥À¡¼ÉôÆþÎÏ¹àÌÜ¤Î¥»¥ëÌ¾¾Î
    protected static $titleNameList; // ¥Ø¥Ã¥À¡¼Éô¥¿¥¤¥È¥ë¹àÌÜ¤Î¥»¥ëÌ¾¾Î

    protected $headerTitleNameList; // ÆþÎÏ¹àÌÜ¤Î¥¿¥¤¥È¥ë¥ê¥¹¥È

    protected $cellAddressList; // ¥»¥ëÌ¾¾Î¤ËÂÐ±þ¤·¤¿¥»¥ë°ÌÃÖ¤Î¥ê¥¹¥È

    public function __construct() {

    }

    protected function setNameList() {
        if (!self::$nameList) {
            self::$nameList = workSheetConst::WORK_SHEET_HEADER_DATA_CELL;
        }
    }

    protected function setTitleNameList() {
        if (!self::$titleNameList) {
            self::$titleNameList = workSheetConst::WORK_SHEET_HEADER_TITLE_CELL;
        }
    }

    // ¥»¥ëÌ¾¾Î¤ËÂÐ±þ¤·¤¿¥»¥ë¤Î¥ê¥¹¥È¤È¹ÔÈÖ¹æ¤Ë¤è¤ë½é´ü¥Ç¡¼¥¿ºîÀ®
    public function initialize($cellAddressList, $loginUserCode) {
        $this->cellAddressList = $cellAddressList;
        $this->setNameList();
        $this->setTitleNameList();
        $params = $this->getCellParams();
        $this->setCellParams($params);
        $this->setCellTitleParams();
        $this->loginUserCode = $loginUserCode;
        return true;
    }

    // ³Æ¹àÌÜ¤Î¥Ç¡¼¥¿¤ò¼èÆÀ¤¹¤ë
    protected function getCellParams() {
        $nameList = self::$nameList;
        $cellAddressList = $this->cellAddressList;
        global $sheet;
        if ($nameList) {
            foreach ($nameList as $key => $cellName) {
                $cellAdress = $cellAddressList[$cellName];
                $param[$key] = $sheet->getCell($cellAdress)->getCalculatedValue();
            }
        } else {
            return false;
        }
        return $param;
    }

    // ³Æ¹àÌÜ¤Î¥¿¥¤¥È¥ëÌ¾¤ò¼èÆÀ¤¹¤ë
    protected function setCellTitleParams() {
        $nameList = self::$titleNameList;
        $cellAddressList = $this->cellAddressList;
        global $sheet;
        if ($nameList) {
            foreach ($nameList as $key => $cellName) {
                $cellAdress = $cellAddressList[$cellName];
                $param[$key] = $sheet->getCell($cellAdress)->getCalculatedValue();
            }
        } else {
            return false;
        }
        $this->headerTitleNameList = $param;
        return true;
    }

    public function calculateParam($objRowList, $objHeader, $cellAddressList, $standardRateMaster) {
        global $sheet;
        // ½þµÑ¤Î¸¡º÷¾ò·ï¼èÆÀ
        $cellPayoffCircle = $cellAddressList[workSheetConst::HIDDEN_PAYOFF_CIRCLE];
        $payoffCircle = $sheet->getCell($cellPayoffCircle)->getCalculatedValue();

        // ËÜ²Ù¤Î¸¡º÷¾ò·ï¼èÆÀ
        $cellMainProduct = $cellAddressList[workSheetConst::HIDDEN_MAIN_PRODUCT];
        $mainProduct = $sheet->getCell($cellMainProduct)->getCalculatedValue();

        foreach ($objRowList as $objRow) {
            if ($objRow->invalidFlag === false) {
                $areaCode = $objRow->areaCode;
                // ºÆ·×»»·ë²Ì¤¬¤Ê¤¤¾ì¹ç¤Ï¼èÆÀÃÍ¤ò»²¾È¤¹¤ë
                $subtotal = $objRow->calculatedSubtotal ? $objRow->calculatedSubtotal : $objRow->subtotal;
                switch ($areaCode) {
                    case DEF_AREA_PRODUCT_SALES:
                        $quantity = $objRow->quantity;
                        $classItem = $objRow->classItem;
                        // À½ÉÊÇä¾å¹ç·×
                        $receiveProductTotalPrice += $subtotal;
                        // À½ÉÊ¿ôÎÌ¹ç·×
                        $receiveProductTotalQuantity += $quantity;
                        // ½þµÑ¿ô
                        if ($classItem === $mainProduct) {
                            $productionQuantity += $quantity;
                        }
                        break;
                    case DEF_AREA_FIXED_COST_SALES:
                        $quantity = $objRow->quantity;
                        // ¸ÇÄêÈñÇä¾å¹ç·×
                        $receiveFixedCostTotalPrice += $subtotal;
                        // ¸ÇÄêÈñ¿ôÎÌ¹ç·×
                        $receiveFixedCostTotalQuantity += $quantity;
                        break;
                    case DEF_AREA_FIXED_COST_ORDER:
                        $payoff = $objRow->payoff;
                        // ¸ÇÄêÈñ¾®·×
                        $orderFixedCostTotalPrice += $subtotal;
                        
                        if ($payoff === $payoffCircle) {
                            // ½þµÑÈñ
                            $depreciationCost += $subtotal;
                        } else {
                            // ½þµÑÂÐ¾Ý³°¹ç·×
                            $orderFixedCostNotDepreciation += $subtotal;
                        }
                        break;
                    case DEF_AREA_PARTS_COST_ORDER:
                        $payoff = $objRow->payoff;
                        
                        if ($payoff === $payoffCircle) {
                            // ½þµÑÈñ
                            $depreciationCost += $subtotal;
                        } else {
                            // ÉôºàÈñ
                            $memberCost += $subtotal;
                        }
                        break;
                    default:
                        break;
                }
            }
        }

        // ¤½¤ÎÂ¾·×»»
        // À½ÉÊÇä¾å¹â
        $productTotalPrice = $receiveProductTotalPrice;
        // À½Â¤ÈñÍÑ
        $manufacturingCost = $depreciationCost + $memberCost;
        // À½ÉÊÍø±×
        $productProfit = $productTotalPrice - $manufacturingCost;
        // À½ÉÊÍø±×Î¨
        $productProfitRate = $productProfit / $manufacturingCost;
        // ¸ÇÄêÈñÇä¾å¹â
        $fixedCostTotalPrice = $receiveFixedCostTotalPrice;
        // ¸ÇÄêÈñÍø±×
        $fixedCostProfit = $fixedCostTotalPrice - $orderFixedCostNotDepreciation;
        // ¸ÇÄêÈñÍø±×Î¨
        $fixedCostProfitRate = $fixedCostProfit / $fixedCostTotalPrice;
        // ÁíÇä¾å¹â
        $salesAmount = $productTotalPrice + $fixedCostTotalPrice;
        // Çä¾åÁíÍø±×
        $profit = $productProfit + $fixedCostProfit;
        // Íø±×Î¨
        $profitRate = $profit / $salesAmount;
        // É¸½à³ä¹ç
        $standardRate = $standardRateMaster;
        // ´ÖÀÜÀ½Â¤·ÐÈñ
        $indirectCost = floor($salesAmount * $standardRate);
        // ±Ä¶ÈÍø±×
        $operatingProfit = $profit - $indirectCost;
        // ±Ä¶ÈÍø±×Î¨
        $operatingProfitRate = $operatingProfit / $salesAmount;
        // ÉôºàÈñ¸Ä¿ô
        $memberQuantity = $productionQuantity;
        // ½þµÑÈñ¸Ä¿ô
        $depreciationQuantity = $productionQuantity;
        // À½Â¤ÈñÍÑ¸Ä¿ô
        $manufacturingQuantity = $productionQuantity;
        // ÉôºàÈñÃ±²Á
        $memberUnitCost = ($memberQuantity > 0) ? $memberCost / $memberQuantity : 0;
        // ½þµÑÈñÃ±²Á
        $depreciationUnitCost = ($depreciationQuantity > 0) ? $depreciationCost / $depreciationQuantity : 0;
        // À½Â¤ÈñÍÑ
        $manufacturingUnitCost = ($manufacturingQuantity > 0) ? $manufacturingCost / $manufacturingQuantity : 0;
        // ½þµÑÂÐ¾Ý³°¸ÇÄêÈñ
        $costNotDepreciation = $orderFixedCostNotDepreciation;

        // ¥¯¥é¥¹¤Î¥×¥í¥Ñ¥Æ¥£¤Ë¥»¥Ã¥È
        $this->receiveProductTotalPrice = $receiveProductTotalPrice;
        $this->receiveProductTotalQuantity = $receiveProductTotalQuantity;
        $this->productionQuantity = $productionQuantity;
        $this->receiveFixedCostTotalPrice = $receiveFixedCostTotalPrice;
        $this->receiveFixedCostTotalQuantity = $receiveFixedCostTotalQuantity;
        $this->orderFixedCostTotalPrice = $orderFixedCostTotalPrice;
        $this->depreciationCost = $depreciationCost;
        $this->orderFixedCostNotDepreciation = $orderFixedCostNotDepreciation;
        $this->memberCost = $memberCost;
        $this->productTotalPrice = $productTotalPrice;
        $this->manufacturingCost = $manufacturingCost;
        $this->productProfit = $productProfit;
        $this->productProfitRate = $productProfitRate;
        $this->fixedCostTotalPrice = $fixedCostTotalPrice;
        $this->fixedCostProfit = $fixedCostProfit;
        $this->fixedCostProfitRate = $fixedCostProfitRate;
        $this->salesAmount = $salesAmount;
        $this->profit = $profit;
        $this->profitRate = $profitRate;
        $this->standardRate = $standardRate;
        $this->indirectCost = $indirectCost;
        $this->operatingProfit = $operatingProfit;
        $this->operatingProfitRate = $operatingProfitRate;
        $this->memberQuantity = $memberQuantity;
        $this->depreciationQuantity = $depreciationQuantity;
        $this->manufacturingQuantity = $manufacturingQuantity;
        $this->memberUnitCost = $memberUnitCost;
        $this->depreciationUnitCost = $depreciationUnitCost;
        $this->manufacturingUnitCost = $manufacturingUnitCost;
        $this->costNotDepreciation = $costNotDepreciation;

        return true;
    }

    // ¥ï¡¼¥¯¥·¡¼¥ÈÆâ¤Î¥»¥ëÌ¾¾Î¤ËÂÐ±þ¤·¤¿¥Ç¡¼¥¿¡Ê·×»»·ë²Ì¡Ë¤ò½ÐÎÏ¤¹¤ë
    public function outputParam() {
        $data = array(
            workSheetConst::RECEIVE_PRODUCT_TOTAL_PRICE => $this->receiveProductTotalPrice,
            workSheetConst::RECEIVE_PRODUCT_TOTAL_QUANTITY => $this->receiveProductTotalQuantity,
            workSheetConst::PRODUCTION_QUANTITY => $this->productionQuantity,
            workSheetConst::RECEIVE_FIXED_COST_TOTAL_PRICE => $this->receiveFixedCostTotalPrice,
            workSheetConst::RECEIVE_FIXED_COST_TOTAL_QUANTITY => $this->receiveFixedCostTotalQuantity,
            workSheetConst::ORDER_FIXED_COST_FIXED_COST => $this->orderFixedCostTotalPrice,
            workSheetConst::DEPRECIATION_COST => $this->depreciationCost,
            workSheetConst::ORDER_FIXED_COST_COST_NOT_DEPRECIATION => $this->orderFixedCostNotDepreciation,
            workSheetConst::MEMBER_COST => $this->memberCost,
            workSheetConst::PRODUCT_TOTAL_PRICE => $this->productTotalPrice,
            workSheetConst::MANUFACTURING_COST => $this->manufacturingCost,
            workSheetConst::PRODUCT_PROFIT => $this->productProfit,
            workSheetConst::PRODUCT_PROFIT_RATE => $this->productProfitRate,
            workSheetConst::FIXED_COST_TOTAL_PRICE => $this->fixedCostTotalPrice,
            workSheetConst::FIXED_COST_PROFIT => $this->fixedCostProfit,
            workSheetConst::FIXED_COST_PROFIT_RATE => $this->fixedCostProfitRate,
            workSheetConst::SALES_AMOUNT => $this->salesAmount,
            workSheetConst::PROFIT => $this->profit,
            workSheetConst::PROFIT_RATE => $this->profitRate,
            workSheetConst::STANDARD_RATE => $this->standardRate,
            workSheetConst::INDIRECT_COST => $this->indirectCost,
            workSheetConst::OPERATING_PROFIT => $this->operatingProfit,
            workSheetConst::OPERATING_PROFIT_RATE => $this->operatingProfitRate,
            workSheetConst::MEMBER_QUANTITY => $this->memberQuantity,
            workSheetConst::DEPRECIATION_QUANTITY => $this->depreciationQuantity,
            workSheetConst::MANUFACTURING_QUANTITY => $this->manufacturingQuantity,
            workSheetConst::MEMBER_UNIT_COST => $this->memberUnitCost,
            workSheetConst::DEPRECIATION_UNIT_COST => $this->depreciationUnitCost,
            workSheetConst::MANUFACTURING_UNIT_COST => $this->manufacturingUnitCost,
            workSheetConst::COST_NOT_DEPRECIATION => $this->costNotDepreciation
        );
        return $data;
    }

    // À½ÉÊ¥³¡¼¥É¤ÎÆþÎÏÃÍ¤ò¥Ð¥ê¥Ç¡¼¥·¥ç¥ó¤¹¤ë
    protected function validateProductCode() {
        $productCode = $this->productCode;
        // ¥Ð¥ê¥Ç¡¼¥·¥ç¥ó¾ò·ï
        if (isset($productCode) && $productCode !=='') {
            if(!preg_match("/\A[0-9]+\z/", $productCode)) {
                // ¥¨¥é¡¼½èÍý
                $this->messageCode['productCode'] = 9201;
            }
        } else {
            $this->messageCode['productCode'] = 9001; // É¬¿Ü¥Á¥§¥Ã¥¯
        }
        return true;
    }

    // À½ÉÊÌ¾
    protected function validateProductName() {
        $productName = $this->productName;
        // ¥Ð¥ê¥Ç¡¼¥·¥ç¥ó¾ò·ï
        if (!isset($productName) || $productName ==='') {
            // ¥¨¥é¡¼¥á¥Ã¥»¡¼¥¸or¥¨¥é¡¼¥³¡¼¥É½ÐÎÏ¡ÊÉ¬¿Ü¥¨¥é¡¼¡Ë
            $this->messageCode['productName'] = 9001; // É¬¿Ü
        }
        return true;
    }

    // À½ÉÊÌ¾¡Ê±Ñ¸ì¡Ë
    protected function validateProductEnglishName() {
        $productEnglishName = $this->productEnglishName;
        // Ê¸»úÎó¥Á¥§¥Ã¥¯(È¾³Ñ±Ñ¿ô»úµ­¹æ ASCII¤Î0x20¢·0x7e)
        if (isset($productEnglishName) && $productEnglishName !=='') {
            if(!preg_match("/\A[ -~]+\z/", $productEnglishName)) {
                // ¥¨¥é¡¼½èÍý
                $this->messageCode['productEnglishName'] = 9201;
            }
        } else {
            $this->messageCode['productEnglishName'] = 9001; // É¬¿Ü¥Á¥§¥Ã¥¯
        }
        return true;
    }

    // ¾åÂå
    protected function validateRetailPrice() {
        $retailPrice = $this->retailPrice;
        if (isset($retailPrice) && $retailPrice !=='') {
            if(!preg_match("/\A[0-9]+\z/", $retailPrice)) {
                // ¥¨¥é¡¼½èÍý
                $this->messageCode['retailPrice'] = 9201;
            }
        } else {
            $this->messageCode['retailPrice'] = 9001; // É¬¿Ü¥Á¥§¥Ã¥¯
        }
        return true;
    }

    // ±Ä¶ÈÉô½ð¥Á¥§¥Ã¥¯
    protected function validateInchargeGroupCode() {
        $inchargeGroupCode = $this->inchargeGroupCode;
        // ¥Ð¥ê¥Ç¡¼¥·¥ç¥ó¾ò·ï
        if (isset($inchargeGroupCode) && $inchargeGroupCode !=='') {
            if (preg_match("/\A[0-9]+:.+\z/", $inchargeGroupCode)) {
                list ($inchargeGroupCodeNumber, $inchargeGroupCodeName) = explode(':', $inchargeGroupCode);
                global $objDB; // ¥°¥í¡¼¥Ð¥ë¤Î¥Ç¡¼¥¿¥Ù¡¼¥¹¥ª¥Ö¥¸¥§¥¯¥È¼èÆÀ
                $result = $objDB->checkGroupExist($inchargeGroupCodeNumber);
                // ¥Þ¥¹¥¿¡¼¥Á¥§¥Ã¥¯
                if (!$result) {
                    $this->messageCode['inchargeGroupCode'] = 9202;
                } else {
                    $this->inchargeGroupCodeNumber = $inchargeGroupCodeNumber; // ¥°¥ë¡¼¥×¥³¡¼¥É¤ò¥»¥Ã¥È¤¹¤ë
                }
            } else {
                // ÆþÎÏ·Á¼°ÉÔÀµ
                $this->messageCode['inchargeGroupCode'] = 9201;
            }
        } else {
            // É¬¿Ü¥¨¥é¡¼
            $this->messageCode['inchargeGroupCode'] = 9001;
        }
        return true;
    }

    // ³«È¯Ã´Åö¼Ô¤Î¥Á¥§¥Ã¥¯¤ò¹Ô¤¦
    protected function validateUserCode() {
        $userCode = $this->userCode;
        // ¥Ð¥ê¥Ç¡¼¥·¥ç¥ó¾ò·ï
        if (isset($userCode) && $userCode !=='') {
            if (preg_match("/\A[0-9]+:.+\z/", $userCode)) {
                list ($userCodeNumber, $userCodeName) = explode(':', $userCode);
                global $objDB; // ¥°¥í¡¼¥Ð¥ë¤Î¥Ç¡¼¥¿¥Ù¡¼¥¹¥ª¥Ö¥¸¥§¥¯¥È¼èÆÀ
                $result = $objDB->checkUserExist($userCodeNumber);
                // ¥Þ¥¹¥¿¡¼¥Á¥§¥Ã¥¯
                if (!$result) {
                    $this->messageCode['userCode'] = 9202;
                } else {
                    $this->userCodeNumber = $userCodeNumber; // ¥°¥ë¡¼¥×¥³¡¼¥É¤ò¥»¥Ã¥È¤¹¤ë
                }
            } else {
                // ÆþÎÏ·Á¼°ÉÔÀµ
                $this->messageCode['userCode'] = 9201;
            }
        } else {
            // É¬¿Ü¥¨¥é¡¼
            $this->messageCode['userCode'] = 9001;
        }
        return true;
    }

    // ¥«¡¼¥È¥óÆþ¤ê¿ô
    protected function validateCartonQuantity() {
        $cartonQuantity = $this->cartonQuantity;
        if (isset($cartonQuantity) && $cartonQuantity !=='') {
            if (!preg_match("/\A[1-9][0-9]*\z/", $cartonQuantity)) {
                // ÆþÎÏ·Á¼°ÉÔÀµ
                $this->messageCode['cartonQuantity'] = 9201;
            }
        } else {
            // É¬¿Ü¥¨¥é¡¼
            $this->messageCode['cartonQuantity'] = 9001;
        }
        return true;
    }

    // ½þµÑ¿ô
    protected function validateProductionQuantity() {
        $productionQuantity = $this->productionQuantity;
        if (isset($productionQuantity) && $productionQuantity !=='') {
            if (!preg_match("/\A[1-9][0-9]*\z/", $productionQuantity)) {
                // ÆþÎÏ·Á¼°ÉÔÀµ
                $this->messageCode['productionQuantity'] = 9201;
            }
        } else {
            // É¬¿Ü¥¨¥é¡¼
            $this->messageCode['productionQuantity'] = 9001;
        }
        return true;
    }

    // 	if( !fncCheckGroup( $objDB, $aryProductHeader, $lngUserDispCode ) )
// 	{
// 		$strErrMsg	= "¡Ê¥í¥°¥¤¥ó¼Ô¤ÈExcel¥Ç¡¼¥¿¾å¤ÎÉôÌç¤¬°Û¤Ê¤ê¤Þ¤¹¡£¡Ë";
// 		$strErrMsg	= mb_convert_encoding( $strErrMsg, "EUC-JP", "EUC-JP,UTF-8,SJIS,ASCII,JIS" );

// 		// ¥°¥ë¡¼¥×¤¬°ã¤¦¾ì¹ç¡¢½èÍý½ªÎ»
// 		fncOutputError( 1603, DEF_WARNING, $strErrMsg, TRUE, "", $objDB );
// 	}

}