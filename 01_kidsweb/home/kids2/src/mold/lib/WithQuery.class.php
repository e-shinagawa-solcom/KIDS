<?php

require_once(SRC_ROOT.'/mold/lib/Singleton.class.php');
require_once(SRC_ROOT.'/mold/lib/exception/NoSuchFileException.class.php');
require_once('clsdb.php');

/**
 * DB??????????????????É¬????????
 *
 */
class WithQuery extends Singleton
{
	/**
	 * SQL??????????????????????
	 * @var string
	 */
	private $pathQuery = 'mold/sql/';

	/**
	 * SQL??????????????
	 * @var string
	 */
	private $pathSqlFileSuffix = ".sql";

	/**
	 * <pre>
	 * ?????????.??????????
	 * ??????99999
	 * INSERT/UPDATE???É»?????/??????????????????
	 * </pre>
	 *
	 * @var integer
	 */
	protected  $userCode = 99999;

	/**
	 * DB????
	 * @var clsDB
	 */
	protected static $db;

	/**
	 * ????????
	 *
	 * clsDB??????????????
	 *
	 * @param clsDB
	 */
	protected function __construct()
	{
		static::$db = new clsDB();
		static::$db->open("", "", "", "");
	}

	/**
	 * ????????
	 *
	 * clsDB?É≤????????????
	 *
	 */
	function __destruct()
	{
		// ??????????OPEN?ÉÃ??
		if(static::$db->isOpen())
		{
			// ??????????????????????
			if (static::$db->isTransaction())
			{
				static::$db->execute("ROLLBACK");
			}

			// ?????????????
			static::$db->close();
		}
	}

	/**
	 * ??????SQL????????É≤????????????
	 *
	 * @param string $fileName
	 * @return SQL?????????
	 * @throws InvalidArgumentException
	 * @see InvalidArgumentException
	 */
	protected function getQueryFileName($fileName)
	{
		if (is_string($fileName))
		{
			$path = SRC_ROOT.$this->pathQuery.$fileName.$this->pathSqlFileSuffix;

			if (!file_exists($path))
			{
				throw new NoSuchFileException("?????????????? :".$path);
			}

			return $path;
		}
		else
		{
			throw new InvalidArgumentException("????É≈????????????????1:".gettype($newPath));
		}
	}


	/**
	 * ???????????????????
	 *
	 * @return ????????
	 */
	protected function getPathQuery()
	{
		return $this->pathQuery;
	}

	/**
	 * ?????????????????
	 *
	 * @param string $newPath ??????????????
	 * @return void
	 * @throws NoSuchFileException
	 * @throws InvalidArgumentException
	 * @see NoSuchFileException
	 * @see InvalidArgumentException
	 */
	protected function setPathQuery($newPath)
	{
		if (is_string($newPath))
		{
			$path = SRC_ROOT.$newPath;

			// ???????????É≤??????
			if(file_exists($path))
			{
				$this->pathQuery = $newPath;
			}
			else
			{
				throw new NoSuchFileException("?????????? :" . $path);
			}
		}
		else
		{
			throw new InvalidArgumentException("????É≈????????????????1:".gettype($newPath));
		}
	}

	/**
	 * ???????????????????????????
	 *
	 * @return ????????????????
	 */
	protected function getPathSqlFileSuffix()
	{
		return $this->pathSqlFileSuffix;
	}

	/**
	 * ?????????????????????????
	 *
	 * @param string $newSuffix ????????????
	 * @return void
	 * @throws InvalidArgumentException
	 * @see InvalidArgumentException
	 */
	protected  function setPathSqlFileSuffix($newSuffix)
	{
		if (is_string($newSuffix))
		{
			$this->pathSqlFileSuffix = $newSuffix;
		}
		else
		{
			throw new InvalidArgumentException("????É≈????????????????1:".gettype($newSuffix));
		}
	}


	/**
	 * ?????????????????????????
	 *
	 * @return ??????????
	 */
	public function getUserCode()
	{
		return $this->userCode;
	}

	/**
	 * ???????????????????????????
	 *
	 * @param integer $newUsercode
	 * @return ????????????????
	 */
	public function setUserCode(integer $newUserCode)
	{
		$this->userCode = $newUserCode;
		return $this->userCode;
	}

}
