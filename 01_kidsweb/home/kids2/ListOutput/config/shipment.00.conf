#	ヘッダ
#	日次の表の YYYY/MM 形式のラベルを取得
&	HEAD_MONTH
%	TEMPLATESTRING
	<td id="listhead" colspan="_%day_count%_" align="center">_%month_label%_</td>
%	SQL
	select
		to_char(to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line, 'YYYY/MM') as month_label,
		count(*) as day_count
	from
		v_line
	where
		to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line <= to_date('_%cal_date_to%_', 'YYYY-MM-DD')
	group by
		to_char(to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line, 'YYYY/MM')
	order by
		to_char(to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line, 'YYYY/MM')

#	ヘッダ
#	出荷スケジュール表のヘッダーとデータのテンプレートを生成
&	HEAD_DATE
%	TEMPLATESTRING
	<td id="listhead" align="center">_%dtmymd%_<br />_%strweekday%_</td>
%	SQL
	select
		to_char(to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line, 'DD') as dtmymd,
		to_char(to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line, 'YYYY-MM-DD') as dtmkey,
		v_dayofweek.tostring as strweekday
	from
		v_line join v_dayofweek on (
			extract(dow from to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line) = v_dayofweek.number
		)
	where
		to_date('_%cal_date_from%_', 'YYYY-MM-DD') + v_line.line <= to_date('_%cal_date_to%_', 'YYYY-MM-DD')
%	EVAL
	$objContext->setPageContext(
		'CAL_TEMPLATE',
		($objContext->isSetPageContext('CAL_TEMPLATE') ? $objContext->getPageContext('CAL_TEMPLATE') : '')
			. '<td align="right">_%strproductquantity_' . $arySQLResult['dtmkey'] . '%_</td>'
	);

#	詳細内容
&	DETAIL
%	TEMPLATESTRING
	<tr bgcolor="_%bgcolor%_">
		<td nowrap>_%strgoodscode%_</td>
		<td nowrap>_%strproductcode%_</td>
		<td nowrap align="right">_%curretailprice%_</td>
		<td nowrap align="right">_%lngcartonquantity%_</td>
		<td nowrap>_%strcompanydisplayname%_</td>
		<td nowrap align="right"><!--C/T--><span title="_%strcalctitle_mp%_">_%strproductionquantity_mp%_</span></td>
		<td nowrap rowspan="2" align="right">&nbsp;<!--注文No.(出荷単価) -->_%RECEIVE_NO%_</td>
		<td nowrap><!--テストロケ日-->_%dtmdeliverydate%_</td>
		<td nowrap align="center">納品日</td>
	_%LINE%_
	</tr>
	<tr bgcolor="_%bgcolor%_">
		<td colspan="5" nowrap>_%strproductname%_</td>
		<td nowrap>_%strinchargeusername%_ → _%strcustomerusername%_</td>
		<td nowrap align="right"><!--テストロケ数-->_%strproductquantity_trd%_</td>
		<td nowrap align="center">ＥＴＤ</td>
	_%LINE_ORDER%_
	</tr>
	
%	SQL
	select distinct
		mp.strGoodsCode
		,mp.strProductCode
		,CASE WHEN mp.curRetailPrice != 0 THEN
			to_char(mp.curRetailPrice, '999,999,999,999.99')
		END AS curRetailPrice
		,mc.strCompanyDisplayName
		,mp.lngProductionQuantity
		,CASE WHEN mp.lngProductionUnitCode = 1 THEN
			to_char(((mp.lngProductionQuantity) / mp.lngCartOnQuantity), '999,999,999,999') || '.'
		 ELSE
			to_char(mp.lngProductionQuantity, '999,999,999,999') || ''
		 END AS strProductionQuantity_mp
		,CASE WHEN mp.lngProductionUnitCode = 1 THEN
			'(' || trim(to_char((mp.lngProductionQuantity), '999,999,999,999')) || '(pcs)/' || trim(to_char(mp.lngCartonQuantity, '999,999,999,999')) ||')'
		 END AS strCalcTitle_mp
		,mp.strProductName
		,mp.lngInChargeUserCode
		,to_char(mp.lngCartonQuantity, '999,999,999,999') AS lngCartonQuantity
		,(select strUserDisplayName from m_user where lngUserCode = mp.lngInChargeUserCode) AS strInChargeUserName
		,CASE WHEN mp.lngCustomerUserCode is null THEN
			mp.strCustomerUserName
		 ELSE
			(select strUserDisplayName from m_user where lngUserCode = mp.lngCustomerUserCode)
		 END AS strCustomerUserName
		,mc.strCompanyDisplayName
		,trd.dtmDeliveryDate
		,CASE WHEN trd.lngProductUnitCode = 1 THEN
			((trd.lngProductQuantity) / mp.lngCartOnQuantity) || '.'
		ELSE
			(trd.lngProductQuantity) || ''
		END AS strProductQuantity_trd
		,CASE WHEN trd.lngProductUnitCode = 1 THEN
			'(' || trim(to_char((trd.lngProductQuantity), '999,999,999,999')) || '(pcs)/' || trim(to_char(mp.lngCartonQuantity, '999,999,999,999')) ||')'
		 END AS strCalcTitle_trd

		,to_char(trd.curProductPrice, '999,999,999,999.99') AS curProductPrice
		,'_%column_lngorderstatuscode_enable%_' AS column_lngorderstatuscode_enable
		,_%lngorderstatuscode%_ AS lngorderstatuscode
		,'_%date_from%_'	AS date_from
		,'_%date_to%_'		AS date_to
		,_%lnggroupcode%_	AS lnggroupcode
		,'_%column_lngusercode_enable%_'	AS column_lngusercode_enable
		,_%lngusercode%_	AS lngusercode
	from
		m_product mp
		left outer join (
			select
				strProductCode
				,min(dtmDeliveryDate) as dtmDeliveryDate
				,curProductPrice
				,lngProductUnitCode
				,lngProductQuantity
			from
				m_Receive mr
				,t_ReceiveDetail
			where
				lngSalesClassCode = 2
				AND mr.bytInvalidFlag = false
				AND mr.strReceiveCode not in (select strReceiveCode from m_Receive where lngRevisionNo < 0)
				AND mr.lngRevisionNo = (select max(lngRevisionNo) from m_Receive where mr.strReceiveCode = strReceiveCode)
				AND mr.lngreceiveno = t_receivedetail.lngreceiveno
			group by
				strProductCode
				,curProductPrice
				,lngProductUnitCode
				,lngProductQuantity
		) trd on (mp.lngProductNo = to_number(trd.strProductCode, '99999999'))
		,m_company mc
		,m_user mu
	where
		mp.lngfactorycode = mc.lngcompanycode
		and (mp.lngInChargeUserCode = mu.lngusercode or mp.lngCustomerUserCode = mu.lngusercode)
		and mp.dtmDeliveryLimitDate >= '_%date_from%_' and mp.dtmDeliveryLimitDate <= '_%date_to%_'
		and mp.lngInChargeGroupCode = _%lnggroupcode%_
		_%column_lngusercode_enable%_and mp.lngInChargeUserCode = _%lngusercode%_
%	ROWNUM
	line
%	EVAL
	$arySQLResult['bgcolor'] = ($arySQLResult['line'] % 2) == 0 ? '#CCCCCC' : '#FFFFFF';


%	CHILDOBJECTIMPORTREPLACELIST
	1
%	CHILDOBJECT
	#	テンプレートを取得する
	&	LINE_TEMPLATE
	%	TEMPLATESTRING
		_%cal_template%_
	%	SQL
		select 1
	%	EVAL
		$arySQLResult['cal_template'] = $objContext->getSessionContext('CAL_TEMPLATE');

	#	納品日のデータを取得する
	&	LINE_TEMP
	%	RESULTTEMPLATE
		LINE_TEMPLATE
	%	SQL
		select 
			mp.strProductCode
			,mp.lngCartonQuantity
			,mr.strReceiveCode || '(' || trd.curProductPrice || ')' as strReceiveCode
			,trd.dtmDeliveryDate as dtmymd
			,case when trd.lngProductUnitCode = 1 then
				to_char((sum(trd.lngProductQuantity) / mp.lngCartonQuantity), '999,999,999,999') || '.'
			else
				to_char(sum(trd.lngProductQuantity), '999,999,999,999') || ''
			end as strProductQuantity
			,case when trd.lngProductUnitCode = 1 then
				'(' || trim(to_char(sum(trd.lngProductQuantity),'999,999,999,999')) || '(pcs)/' || trim(to_char(mp.lngCartonQuantity, '999,999,999,999')) ||')'
			end as strCalcTitle
		from
			m_receive mr
			left join t_receiveDetail trd on mr.lngReceiveNo = trd.lngReceiveNo
			join m_product mp on mp.lngproductno = to_number(trd.strproductcode, '99999999')
		where
			mr.strReceiveCode not in (select strReceiveCode from m_receive where lngRevisionNo < 0)
			and mr.lngRevisioNno = (select max(lngRevisionNo) from m_receive where mr.strReceiveCode = strReceiveCode)
			/* 本荷 */
			and (trd.lngSalesClassCode = 1)
			and trd.dtmDeliveryDate >= '_%cal_date_from%_' and trd.dtmDeliveryDate <= '_%cal_date_to%_'
			and trd.strProductCode = '_%strproductcode%_'
		group by
			mp.strProductCode
			,trd.lngProductUnitCode
			,mp.lngCartOnQuantity
			,mr.strReceiveCode
			,trd.curProductPrice
			,trd.dtmDeliveryDate
	%	NOREPEATLIMIT
		1
	%	NOREPEAT
		strproductquantity__%dtmymd%_
	%	NOREPEATVALUE
		<span title="_%strcalctitle%_">_%strproductquantity%_<span><br />_%strproductquantity__%dtmymd%_%_
	%	PARALLEL
		1

	&	RECEIVE_NO
	%	TEMPLATESTRING
		_%strreceivecode%_
	%	SEPARATOR
		<br />
		

	#	納品日が存在しなかったセルの余計な置き換え文字を削除
	&	LINE
	%	RESULTTEMPLATE
		LINE_TEMP
	%	SQL
		select 1
	%	EVAL
		$arySQLResult['strproductquantity_.+?'] = '';

	#	ETDのデータを取得する
	&	LINE_ORDER_TEMP
	%	RESULTTEMPLATE
		LINE_TEMPLATE
	%	SQL
		select 
			mp.strProductCode
			,mp.lngCartOnQuantity
			,mr.strOrderCode
			,trd.dtmDeliveryDate as dtmymd
			,case when trd.lngProductUnitCode = 1 then
				to_char((sum(trd.lngProductQuantity) / mp.lngCartOnQuantity), '999,999,999,999') || '.'
			else
				to_char(sum(trd.lngProductQuantity), '999,999,999,999') || ''
			end as strProductQuantity
			,case when trd.lngProductUnitCode = 1 then
				'(' || trim(to_char(sum(trd.lngProductQuantity), '999,999,999,999')) || '(pcs)/' || trim(to_char(mp.lngCartOnQuantity, '999,999,999,999')) ||')'
			end as strCalcTitle
		from
			m_order mr
			left join t_orderdetail trd on mr.lngOrderNo = trd.lngOrderNo
			join m_product mp on (mp.lngProductNo = to_number(trd.strProductCode, '99999999'))
		where
			mr.strOrderCode not in (select strOrderCode from m_order where lngRevisionNo < 0)
			and mr.lngRevisionNo = (select max(lngRevisionNo) from m_order where mr.strOrderCode = strOrderCode)
			/* 本荷 */
			and (trd.lngStockSubjectCode = 402 and trd.lngStockItemCode = 1)
			and trd.dtmDeliveryDate >= '_%cal_date_from%_' and trd.dtmDeliveryDate <= '_%cal_date_to%_'
			and trd.strProductCode = '_%strproductcode%_'
		group by
			mp.strProductCode
			,trd.lngProductUnitCode
			,mp.lngCartOnQuantity
			,mr.strOrderCode
			,trd.dtmDeliveryDate
	%	NOREPEATLIMIT
		1
	%	NOREPEAT
		strproductquantity__%dtmymd%_
	%	NOREPEATVALUE
		<span title="_%strcalctitle%_">_%strproductquantity%_<span><br />_%strproductquantity__%dtmymd%_%_

	#	ETDが存在しなかったセルの余計な置き換え文字を削除
	&	LINE_ORDER
	%	RESULTTEMPLATE
		LINE_ORDER_TEMP
	%	SQL
		select 1
	%	EVAL
		$arySQLResult['strproductquantity_.+?'] = '';

## ページ全体
&	PAGE
%	TEMPLATESTRING
	<style>
	#list table ,#list td
	{
		border:1px solid #666666;
		border-spacing:1px;
		border-collapse:collapse;
		padding: 1px;
		font-size:100%;
	 }
	td#listtop
	{
		border-left-width:0px;
		border-right-width:0px;
	}
	td#listhead
	{
		text-align: center;
		background-color: #CCFFFF;
	}
	td#listcol
	{
		vertical-align: top;
	}
	td#listcol_top
	{
		vertical-align: middle;
	}
	</style>
	<div id="list">
	<table>
	<tr>
	<td id="listhead" nowrap>品番</td>
	<td id="listhead" nowrap>コードNo.</td>
	<td id="listhead" nowrap>上代</td>
	<td id="listhead" nowrap>入数</td>
	<td id="listhead" nowrap>工場</td>
	<td id="listhead" nowrap>C/T</td>
	<td id="listhead" rowspan="2" nowrap>注文No.(出荷単価)</td>
	<!-- <td id="listhead" nowrap>新検日</td> -->
	<td id="listhead" nowrap>テストロケ日</td>
	<td id="listhead" rowspan="2" nowrap>&nbsp;</td>
	_%HEAD_MONTH%_
	</tr>
	<tr>
	<td id="listhead" colspan="5" nowrap>商品名</td>
	<td id="listhead" nowrap>担当</td>
	<!-- <td id="listhead" nowrap>注文No.</td> -->
	<!-- <td id="listhead" nowrap>&nbsp;</td> -->
	<td id="listhead" nowrap>テストロケ数</td>
	_%HEAD_DATE%_
	</tr>
	_%DETAIL%_
	</table>
	</div>
%	SQL
	select 1
